name: Build AppImage

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ffmpeg \
            libportaudio2 \
            portaudio19-dev \
            libportaudiocpp0 \
            libxcb-cursor0 \
            libxcb-xinerama0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-xkb1 \
            libxkbcommon-x11-0 \
            libgl1-mesa-glx \
            libegl1 \
            libglib2.0-0 \
            libdbus-1-3

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: |
          pyinstaller blossom.spec

      - name: Download appimagetool
        run: |
          wget -q \
            "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage" \
            -O appimagetool
          chmod +x appimagetool

      - name: Create AppDir structure
        run: |
          mkdir -p Blossom.AppDir

          # Copy PyInstaller output
          cp -r dist/blossom Blossom.AppDir/

          # Icon
          cp blossom_public/BlossomApp/blossom_logo.png Blossom.AppDir/blossom.png

          # .desktop file
          cat > Blossom.AppDir/blossom.desktop << 'EOF'
          [Desktop Entry]
          Name=Blossom
          Exec=blossom
          Icon=blossom
          Type=Application
          Categories=Science;Robotics;
          EOF
          # Remove leading spaces from desktop file
          sed -i 's/^[[:space:]]*//' Blossom.AppDir/blossom.desktop

          # AppRun launcher
          cat > Blossom.AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=$(dirname "$SELF")
          exec "$HERE/blossom/blossom" "$@"
          EOF
          sed -i 's/^[[:space:]]*//' Blossom.AppDir/AppRun
          chmod +x Blossom.AppDir/AppRun

      - name: Build AppImage
        run: |
          ARCH=x86_64 APPIMAGE_EXTRACT_AND_RUN=1 ./appimagetool Blossom.AppDir Blossom-x86_64.AppImage

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Blossom-AppImage
          path: Blossom-x86_64.AppImage
          retention-days: 30
