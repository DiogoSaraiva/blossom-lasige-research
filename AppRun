#!/bin/bash
# AppImage entry point for Blossom LASIGE Research

SELF=$(readlink -f "$0")
HERE=${SELF%/*}
export APPDIR="${APPDIR:-$HERE}"

PYVER="3.11"
PYTHON="$APPDIR/usr/python/bin/python3"
PYLIB="$APPDIR/usr/python/lib/python${PYVER}/site-packages"

export PYTHONHOME="$APPDIR/usr/python"
export PYTHONPATH="$APPDIR/usr/src"
export PATH="$APPDIR/usr/python/bin:$APPDIR/usr/bin:$PATH"
export LD_LIBRARY_PATH="$APPDIR/usr/python/lib:$APPDIR/usr/lib:${LD_LIBRARY_PATH}"

# PyQt6 plugin paths
export QT_QPA_PLATFORM_PLUGIN_PATH="$PYLIB/PyQt6/Qt6/plugins/platforms"
export QT_PLUGIN_PATH="$PYLIB/PyQt6/Qt6/plugins"
export QT_QPA_FONTDIR="$PYLIB/PyQt6/Qt6/fonts"

# Avoid Qt trying to use system theme engines that won't exist
export QT_QPA_PLATFORMTHEME=""

# Desktop integration (first run only)
if [ -n "$APPIMAGE" ]; then
    _DESK="$HOME/.local/share/applications/blossom-lasige-research.desktop"
    if [ ! -f "$_DESK" ]; then
        mkdir -p "$HOME/.local/share/applications" "$HOME/.local/share/icons"
        cp "$APPDIR/blossom.png" "$HOME/.local/share/icons/blossom-lasige-research.png"
        cat > "$_DESK" <<EOF
[Desktop Entry]
Type=Application
Name=Blossom LASIGE Research
Exec=$APPIMAGE
Icon=blossom-lasige-research
Categories=Science;Education;
Terminal=false
StartupWMClass=blossom-lasige-research
EOF
        update-desktop-database "$HOME/.local/share/applications/" 2>/dev/null || true
    fi
fi

exec "$PYTHON" "$APPDIR/usr/src/start.py" "$@"
